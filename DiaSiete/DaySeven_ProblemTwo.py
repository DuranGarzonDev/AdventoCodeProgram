import sys
from functools import lru_cache

def solve_part_two(input_str):
    # Parse the input into a grid
    grid = [line for line in input_str.strip().split('\n')]
    rows = len(grid)
    cols = len(grid[0])

    # Find the starting position 'S'
    start_r, start_c = 0, 0
    for r in range(rows):
        for c in range(cols):
            if grid[r][c] == 'S':
                start_r, start_c = r, c
                break
    
    # Memoization cache to store results for (row, col)
    # This prevents recalculating paths for beams that merge spatially
    @lru_cache(maxsize=None)
    def count_timelines(r, c):
        # Scan downwards from the current position
        curr_r = r
        
        while curr_r < rows:
            cell = grid[curr_r][c]
            
            # If we hit a splitter, we branch
            if cell == '^':
                # The particle splits to the left (c-1) and right (c+1).
                # Crucially, the beams continue *downward* from the splitter's level.
                # So we recurse from the current row (curr_r) but shifted columns.
                
                # We check bounds for safety, though problem implies infinite void/walls
                # Logic: sum of timelines from left branch + right branch
                
                left_paths = count_timelines(curr_r, c - 1)
                right_paths = count_timelines(curr_r, c + 1)
                
                return left_paths + right_paths
            
            # Move down to the next row
            curr_r += 1
        
        # If we exit the while loop, we have reached the bottom of the grid
        # This counts as 1 valid timeline.
        return 1

    # Start the simulation from the start position
    return count_timelines(start_r, start_c)

# --- Example Usage ---
# You can replace this string with your actual puzzle input
example_input = """
......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^.^.^....................................................................
.............................................................................................................................................
...................................................................^...^.^...................................................................
.............................................................................................................................................
..................................................................^.^.^...^..................................................................
.............................................................................................................................................
.................................................................^...^.^.^.^.................................................................
.............................................................................................................................................
................................................................^.^.^.^.^.^.^................................................................
.............................................................................................................................................
...............................................................^.^.^...^.^...^...............................................................
.............................................................................................................................................
..............................................................^.^.^...^.^.^...^..............................................................
.............................................................................................................................................
.............................................................^.^.^.....^.^.^.^.^.............................................................
.............................................................................................................................................
............................................................^.^.^.^...^.^.....^.^............................................................
.............................................................................................................................................
...........................................................^.^.......^...^.^.^.^.^...........................................................
.............................................................................................................................................
..........................................................^.^...^.^.^...^.^.^.^.^.^..........................................................
.............................................................................................................................................
.........................................................^.^.^...^.^.^.^.^.^.^.^.^.^.........................................................
.............................................................................................................................................
........................................................^.^.^.^.........^.^...^...^.^........................................................
.............................................................................................................................................
.......................................................^.^.^...^.^.....^.^.^.......^.^.......................................................
.............................................................................................................................................
......................................................^.^.....^.^.^.....^.^.^.....^.^.^......................................................
.............................................................................................................................................
.....................................................^...^.^.^.^.^.^.....^.^.^.^.^.^.^.^.....................................................
.............................................................................................................................................
....................................................^.^...^...^.^.^.^.^.^.^.....^.^.....^....................................................
.............................................................................................................................................
...................................................^.^...^.^.^.^...^...^.....^.^...^.....^...................................................
.............................................................................................................................................
..................................................^.......^.^...^.^.^.^.^.^.....^.^...^...^..................................................
.............................................................................................................................................
.................................................^...^.....^...^...^...^.^.^.^...^.^.^.^...^.................................................
.............................................................................................................................................
................................................^.^.^.^.^...^.....^...^.^.^.^.^.^.^...^.^.^.^................................................
.............................................................................................................................................
...............................................^.^.^.^.......^...^...^.^.^...^.^.^.^.^...^.^.^...............................................
.............................................................................................................................................
..............................................^.^.^...^.^.^.^.^...^.^.....^.^.^.^.^.....^.^.^.^..............................................
.............................................................................................................................................
.............................................^.^.^.^.^.^.^...^.^.....^.^.^.^.^...^.....^...^.^.^.............................................
.............................................................................................................................................
............................................^.^.^.^.^.^.^...^.^.^...^.............^.....^.....^.^............................................
.............................................................................................................................................
...........................................^.^.^.....^...^.^.^.^...^.^...^.....^...^.....^.^.^.^.^...........................................
.............................................................................................................................................
..........................................^.^.^.^.^.^.^.^.^...^.^...^.^.......^.^.....^.^.^...^.^.^..........................................
.............................................................................................................................................
.........................................^...^.^.^.......^.....^...^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.........................................
.............................................................................................................................................
........................................^.^.^.^.^.^.....^...^.....^.^.....^.^.^.^.^...^...^.^.^.^...^........................................
.............................................................................................................................................
.......................................^.^.^.^.^.^.^.^.^.^.^.^.^.^.......^.......^.^.....^...^.^...^.^.......................................
.............................................................................................................................................
......................................^.^.^.^.^.^.^...^.^...^.^.^...^...^.....^.^.......^.^.....^...^.^......................................
.............................................................................................................................................
.....................................^.^.^.^.^.^.^.^...^...^.^.^.^...^.^.^.^...^.^.^.^.^.^.^.^...^.^...^.....................................
.............................................................................................................................................
....................................^...^.^...^...^.^.....^.^...^.^.^.^.^...^.^.^.^.^...^.^.^.^...^.^.^.^....................................
.............................................................................................................................................
...................................^.^...^...^.^.....^.....^.....^...^.^.^.^.^...^.^.^.^...^...^.^.^.^...^...................................
.............................................................................................................................................
..................................^...^.^.^.^.....^...^.....^.^.^.........^.^.^.....^.^.^.^.^...^.^.^.^.^.^..................................
.............................................................................................................................................
.................................^.....^.^.^.......^.^.....^.^.^.^.......^.^.^...^.....^.......^.^...^.....^.................................
.............................................................................................................................................
................................^...^.^.^.^.^.^.^.^.....^...^.....^.^.^.....^.^...^.^.^.....^.^.......^.^.^.^................................
.............................................................................................................................................
...............................^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^...^.........^.^.^.^.....^.^.^.^...^...^.^...............................
.............................................................................................................................................
..............................^...^.............^...^.^...^...^.^.....^.^.....^...^.^...^.^.^...^...^.^.^.^...^..............................
.............................................................................................................................................
.............................^...^...^...^...^.^.^.^.........^...^.....^.^.^.^.^.^.^.^.....^.......^.^...^...^.^.............................
.............................................................................................................................................
............................^.^.^.^.^.^.....^.^...^.^.............^.^.^.^.^.^...^.^.^...^.^...^...^.^.^...^...^.^............................
.............................................................................................................................................
...........................^...^...^...^.^.^.^.......^.^.^...^...^...^.^.^...^.^.^...^.^.......^.^.^.^.^.^.....^.^...........................
.............................................................................................................................................
..........................^.^.^.^.^.^.^.^...^.^...^.^...^.^.......^.^...^.^.^.^...^.^...^...^.^...^.^.^.^.^.^.^...^..........................
.............................................................................................................................................
.........................^.....^.^.....^.^...^...^.^.^...^.......^.^.^...^.^.....^.....^...^.^...^.....^...^.^.^.^.^.........................
.............................................................................................................................................
........................^.^.^.^.^.^.^.^.^.....^...^...^...^.^.^.^...^.......^.......^...^...^.^.^...^.^.....^...^.^.^........................
.............................................................................................................................................
.......................^.^...^.^.....^.^...^.....^.^.^.^.^.^.^...........^.......^.^.^.......^.^.^.^.^.^.....^.......^.......................
.............................................................................................................................................
......................^.....^...^.^...^.^.^...^.^.^...^.^...^.^.^...^.....^...^.....^.^.^.^.^.^...^.....^.^.^.^...^.^.^......................
.............................................................................................................................................
.....................^.^.^.^...^.^...^...^.^...^.^.^.^.^.^...^.^.^.^...^.^.......^.^...^.........^.^.^.^...^.....^.^.^.^.....................
.............................................................................................................................................
....................^.^.^.^.^.^...^...........^.^.^.^.^.......^.....^.^...^...^.^.^...^.^.^.^...^.^.^.^.^...^.....^.^...^....................
.............................................................................................................................................
...................^.^.....^.^.^.^.^.^.^.^.^.^.^.......^.....^.........^.^.^.^.^.^.^.^.^.....^.^.^...^.^.^...^.^...^.^.^.^...................
.............................................................................................................................................
..................^.......^.^...^.^...^.^.^.....^.^.^.^.....^.......^...^.^.....^.^.....^.^...^.^.^.^.^.....^.^.^.......^.^..................
.............................................................................................................................................
.................^...^.^.^.^.^.....^.^.^...^.^...^...^...^.^.^.^.^.^...^.....^.^.^...^.^.....^.^.^.^.^.^.^.^.^.....^.......^.................
.............................................................................................................................................
................^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^...^.^.^...^.^.^...^...^.^.....^...^.^.^.^...^.^.....^.^................
.............................................................................................................................................
...............^...^.^.^.^.^.^.^...^.^.....^...^.^.....^.^.....^.^.....^.^.^.^...^.^.^...^.^.....^.^.....^.....^.....^.^.^.^.^...............
.............................................................................................................................................
..............^.^.^...^.........^.^.^.^...^.......^.^.^.^.....^.^.^.^.....^.^.^.....^.^.^.........^.....^.^...^.^...^.^.^.^.^.^..............
.............................................................................................................................................
.............^.^.^.^...^...^.^...^...^.......^.^.^.....^.^.^.^...^...^.^.^.........^.....^.^.....^.......^.^.......^.^.^.^.^.^.^.............
.............................................................................................................................................
............^...^.^.^...............^.^.^.^...^.^.^.^.......^...^.^.^...^.^.^.^...^.^.^.^...^.^.....^.^.^...^.^.....^.^.^.^.^.^.^............
.............................................................................................................................................
...........^.^.^...^.^...^.^.^.^...^.^...^.^.^.....^...^.....^.^.^.^.^...^.^.^.^.....^.^...^.^...^.....^.^.^...^.^.......^...^.^.^...........
.............................................................................................................................................
..........^.^.^.^...^.^.^...^...^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^.......^...^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^..........
.............................................................................................................................................
.........^.....^.^...^.^.....^.^.^...^.^.^...^.^.....^.^.^...^.^.^.^...^.^.^.^.^.^...^...^.^.^.^.^.^.^.....^.^...^.^.^.^...^.^.^...^.........
.............................................................................................................................................
........^...^.^.^.^.^.^.^.^.....^.^.^...^.^.........^.^.^.^.......^...^...^.^.^.^.^...^...^...^...^.......^...^.^.^.^.^...^.^.^.^.^.^........
.............................................................................................................................................
.......^.....^.^.^...^.^...^...^.....^...^.^.......^.....^.^.^.^.^.^.^.^.......^.^.^.^...^...^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.......
.............................................................................................................................................
......^.^.^.^.^.^...^.^.^.^.^.^.^...^...^.^.^.^.....^.^...^...^.^...^.^.^...^.....^.......^.^.^.....^...^.^.^...^...^.^...^.^...^.^...^......
.............................................................................................................................................
.....^...^.......^.^.^.^.^.^.^...^...^...^.^.^...^.^.^.^...^...^.^.^.....^.^.....^...^.....^.....^.^.^...^.^.^...^.^.^...^...^...^.^...^.....
.............................................................................................................................................
....^.^.^...^.^...^.^...^.^...^.^...^.^.^...^.....^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^...^.^...^.^.^...^.^.^.^.^...^...^.^.^.....^....
.............................................................................................................................................
...^.^...^.^.^.^...^.^.^.^.^.^.^...........^.^.^.^...^...^.^.^...^.^.....^.^.^.^.....^...^.^.^.^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.......^...
.............................................................................................................................................
..^.^.^.^...^...^.^.^.....^.^.^.^.^...^.^.^.^...^...^.^.^.^...^...^.......^.^.^.^.^.^.^.^.^.^.^...^.^.^...^...^.^...^...^.^.^.^...^.^.^...^..
.............................................................................................................................................
.^.^.^.......^.....^.^.............^...^.....^.^.^.^.^.........^.^.^.........^.^.^.^.^.^.^...^...^.^...^.......^.^...^.^.^.^...^.^.^...^.^.^.
.............................................................................................................................................
"""

# Calculate and print the result
result = solve_part_two(example_input)
print(f"Total timelines: {result}")